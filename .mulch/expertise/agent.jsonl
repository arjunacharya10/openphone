{"type":"pattern","name":"Agent context files: user.md and openphone.agent","description":"openphone-core loads two context files before every agent turn. user.md: everything about the user (name, prefs, contacts, schedule patterns) — written and updated by the agent itself. openphone.agent: agent persona, model config, tool permissions, offline fallback model. Stored in apps/openphone-core/context/. Injected as system prompt prefix on every LLM call. Format mirrors OpenClaw's .agent file convention.","classification":"tactical","recorded_at":"2026-02-22T05:36:44.672Z","id":"mx-f16ef3"}
{"type":"pattern","name":"Agent loop: streamSimple() + tool dispatch","description":"Agent turn uses streamSimple() from @mariozechner/pi-ai. Loop: build system prompt (openphone.agent + user.md), call streamSimple with tool definitions, if response has tool_use dispatch the tool function, append result, loop until end_turn or max iterations (hard limit: 10). Tools are plain async functions. create_card tool writes to SQLite and broadcasts via WebSocket. All turns logged to ledger table. Conversation history stored as JSONL per session.","classification":"tactical","recorded_at":"2026-02-22T05:36:50.526Z","id":"mx-fbbd59"}
{"type":"pattern","name":"Inbound flow: channel → openphone-core → agent → card or silent execute","description":"Inbound communication (Gmail Pub/Sub, Calendar polling) hits openphone-core first. openphone-core enriches with user.md context and runs an agent turn. Agent either: (a) executes autonomously using tools (send reply, archive, etc) and logs to ledger, or (b) calls create_card() when user input is needed — card appears in UI via WebSocket. User card action triggers a follow-up agent turn with the same sessionKey to continue the task.","classification":"tactical","recorded_at":"2026-02-22T05:36:56.272Z","id":"mx-7743f7"}
{"type":"reference","name":"pi-ai provider/model string format and API shapes","description":"Models referenced as 'provider/model' strings. Built-in: anthropic/claude-opus-4-6, openai/gpt-4o, google/gemini-2.0-flash. Local/offline: ollama/llama3.2 (requires Ollama running at localhost:11434). Two API shapes: openai-completions (OpenAI, Ollama, vLLM, LM Studio, Groq, Mistral, OpenRouter) and anthropic-messages (Anthropic direct). openphone.agent specifies primary model and offline_fallback. Key rotation: OPENPHONE_AI_KEYS env var, comma-separated.","classification":"tactical","recorded_at":"2026-02-22T05:37:03.300Z","id":"mx-f2398d"}
{"type":"pattern","name":"Gmail inbound via gogcli watch serve","description":"Run 'gog gmail watch serve --hook-url http://localhost:3000/inbound/gmail' so openphone-core receives Pub/Sub push. Inbound route parses payload, calls runInboundTurn(eventDescription, sessionKey) where eventDescription summarizes new message(s). Agent decides: create_card for user attention or log_action for auto-handled.","classification":"tactical","recorded_at":"2026-02-22T06:05:33.443Z","id":"mx-9845bf"}
{"type":"pattern","name":"OpenClaw-style context files","description":"Agent context split: openphone.agent (meta only: name, model, offline_fallback); SOUL.md (persona); AGENTS.md (rules, Every Session); user.md (user profile); MEMORY.md (long-term); memory/YYYY-MM-DD.md (daily logs). buildSystemPrompt(config) loads all, concatenates. Tools: update_user_context, update_memory, append_daily_log.","classification":"tactical","recorded_at":"2026-02-22T06:48:54.235Z","id":"mx-6dd70e"}
{"type":"reference","name":"Agent memory tools","description":"update_user_context: append to user.md (preferences, contacts). update_memory: append to MEMORY.md (long-term facts, decisions). append_daily_log: append to memory/YYYY-MM-DD.md (today's raw log). All in context/; memory/ created on first append_daily_log.","classification":"tactical","recorded_at":"2026-02-22T06:48:56.633Z","id":"mx-06eb6d"}
{"type":"pattern","name":"session persistence","description":"In-memory session store (sessions.ts) with getSessionHistory/setSessionHistory and withSessionLock. ws.ts loads history before runAgentTurn, saves returned history after. History trimmed to 30 messages. Turn lock serializes concurrent chat messages per session.","classification":"tactical","recorded_at":"2026-02-22T06:59:21.799Z","id":"mx-012386"}
{"type":"pattern","name":"streaming chat with card context","description":"runAgentTurnStream uses streamSimple and onDelta callback. chat:delta broadcasts text chunks, chat:response final text. Session key ui:chat:cardId or ui:chat:general. Card context injected into system prompt when cardId present. UI ChatArea displays user (italic+muted) and assistant (normal) messages.","classification":"tactical","recorded_at":"2026-02-22T07:32:15.948Z","id":"mx-5333ec"}
{"type":"reference","name":"OpenRouter custom model","description":"openrouter/free not in pi-ai registry; loop.ts constructs model object manually (provider openrouter, baseUrl openrouter.ai/api/v1, model id openrouter/free). OPENROUTER_API_KEY env for auth.","classification":"tactical","recorded_at":"2026-02-22T07:33:40.232Z","id":"mx-2b6e3f"}
{"type":"pattern","name":"memory_get tool","description":"Read MEMORY.md, user.md, memory/YYYY-MM-DD.md on demand. OpenClaw-style. Path validation via isAllowedMemoryPath. Optional from/lines for partial reads. Use when user asks for full log or specific date.","classification":"tactical","recorded_at":"2026-02-22T16:27:55.656Z","id":"mx-bb6bd2"}

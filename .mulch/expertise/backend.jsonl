{"type":"pattern","name":"Modular Fastify route structure","description":"src/server.ts only handles app creation, plugin registration, and listen. Routes split into src/routes/health.ts (GET /health), src/routes/cards.ts (GET/POST /cards, POST /cards/:id/action), src/routes/ws.ts (WebSocket at /ws). src/services/store.ts is the only place that touches the DB. src/lib/broadcast.ts manages WebSocket client set.","recorded_at":"2026-02-22T04:36:05.180Z","classification":"tactical","id":"mx-a03bbd"}
{"type":"pattern","name":"Store mutation → broadcast pattern","description":"Every store mutation (createCard, actOnCard, recordAction) writes to SQLite via Drizzle then calls broadcast() with the appropriate event type. broadcast() sends JSON to all connected WebSocket clients whose readyState === 1.","recorded_at":"2026-02-22T04:36:05.193Z","classification":"tactical","id":"mx-284706"}
{"type":"reference","name":"WebSocket event types","description":"Server→client: connected, cards:sync, card:created, card:removed, ledger:sync, action:recorded, calendar:sync. Client→server: card:action (payload: {cardId, action}), chat:message (payload: {message}). All wrapped in {type, payload, timestamp} envelope.","recorded_at":"2026-02-22T04:36:05.193Z","classification":"tactical","id":"mx-9ef17b"}
{"type":"reference","name":"Database setup","description":"SQLite via better-sqlite3 + Drizzle ORM. DB at ./data/openphone.db (gitignored). Tables: cards, ledger, calendar_events. drizzle.config.ts at apps/openphone-core root. Scripts: npm run db:push (create/update tables), npm run db:generate (generate migration files). seedDemoData() is idempotent — skips if cards table already has rows.","recorded_at":"2026-02-22T04:36:05.193Z","classification":"tactical","id":"mx-463ac5"}
{"type":"convention","content":"Contracts live in contracts/ at repo root. TypeScript types: Card, CardAction, LedgerEntry, CalendarEvent, WSEvent<T>, ServerEventType, ClientEventType. Import in backend as relative path: ../../../../contracts/events/index.js (note .js extension for ESM).","recorded_at":"2026-02-22T04:36:05.193Z","classification":"tactical","id":"mx-992f56"}
{"type":"reference","name":"gogcli Gmail CLI","description":"gogcli (github.com/steipete/gogcli): Go CLI for Gmail, Calendar, Drive, etc. Key Gmail commands: gog gmail search 'query' --max N, gog gmail thread get <threadId>, gog gmail send --to --subject --body, gog gmail labels list/modify. Auth via gog auth credentials + gog auth add (OAuth) or service account. Use --json for scripting. Install: brew install steipete/tap/gogcli or build from source.","classification":"tactical","recorded_at":"2026-02-22T06:05:29.606Z","id":"mx-88b362"}
{"type":"reference","name":"gogcli Gmail watch (Pub/Sub push)","description":"gog gmail watch start --topic projects/<p>/topics/<t> --label INBOX; gog gmail watch serve --bind 127.0.0.1 --port 8788 --path /gmail-pubsub --token <shared> --hook-url <url>. Hook receives POST with { source, account, historyId, messages: [{ id, threadId, from, subject, snippet, body?, labels }] }. Auth: OIDC JWT preferred; fallback x-gog-token for dev. See docs/watch.md in gogcli repo.","classification":"tactical","recorded_at":"2026-02-22T06:05:31.683Z","id":"mx-4909cc"}

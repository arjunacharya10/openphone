{"type":"pattern","name":"Modular Fastify route structure","description":"src/server.ts only handles app creation, plugin registration, and listen. Routes split into src/routes/health.ts (GET /health), src/routes/cards.ts (GET/POST /cards, POST /cards/:id/action), src/routes/ws.ts (WebSocket at /ws). src/services/store.ts is the only place that touches the DB. src/lib/broadcast.ts manages WebSocket client set.","recorded_at":"2026-02-22T04:36:05.180Z","classification":"tactical","id":"mx-a03bbd"}
{"type":"pattern","name":"Store mutation → broadcast pattern","description":"Every store mutation (createCard, actOnCard, recordAction) writes to SQLite via Drizzle then calls broadcast() with the appropriate event type. broadcast() sends JSON to all connected WebSocket clients whose readyState === 1.","recorded_at":"2026-02-22T04:36:05.193Z","classification":"tactical","id":"mx-284706"}
{"type":"reference","name":"WebSocket event types","description":"Server→client: connected, cards:sync, card:created, card:removed, ledger:sync, action:recorded, calendar:sync. Client→server: card:action (payload: {cardId, action}), chat:message (payload: {message}). All wrapped in {type, payload, timestamp} envelope.","recorded_at":"2026-02-22T04:36:05.193Z","classification":"tactical","id":"mx-9ef17b"}
{"type":"reference","name":"Database setup","description":"SQLite via better-sqlite3 + Drizzle ORM. DB at ./data/openphone.db (gitignored). Tables: cards, ledger, calendar_events. drizzle.config.ts at apps/openphone-core root. Scripts: npm run db:push (create/update tables), npm run db:generate (generate migration files). seedDemoData() is idempotent — skips if cards table already has rows.","recorded_at":"2026-02-22T04:36:05.193Z","classification":"tactical","id":"mx-463ac5"}
{"type":"convention","content":"Contracts live in contracts/ at repo root. TypeScript types: Card, CardAction, LedgerEntry, CalendarEvent, WSEvent<T>, ServerEventType, ClientEventType. Import in backend as relative path: ../../../../contracts/events/index.js (note .js extension for ESM).","recorded_at":"2026-02-22T04:36:05.193Z","classification":"tactical","id":"mx-992f56"}
